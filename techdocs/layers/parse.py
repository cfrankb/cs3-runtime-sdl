import json

COPYRIGHT_NOTICE = (
    """
/*
    cs3-runtime-sdl
    Copyright (C) 2025  Francois Blanchette

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
""".strip()
    + "\n"
)

DEST_PATH = "/home/cfrankb/toolkit/gcc/cs3-runtime-sdl/src/"
DEST_PATH = "out/"

HEADER = """
#pragma once

#include <cstdint>

struct layerdata_t {
    uint8_t nextTile;
    uint8_t animeSpeed;
    uint8_t tileType;
    uint8_t weight;
    const char *tag;
};

enum LayerTileType {
    Background,
    Foreground,
    Solid,
    Deadly,
    Water,
};

extern const layerdata_t g_layerdata[256];

constexpr inline const layerdata_t & getLayerTileDef(int i) {
    return g_layerdata[i];
}
""".strip()


with open("data/layer0.json") as sfile:
    data = json.load(sfile)


# rows = []
tiledata = []

for tile in data["tiles"]:

    if tile["tag"]:
        print(tile)

    # row = [
    #     # str(tile["index"]),
    #     "0" if tile["next"] < 0 else str(tile["next"]),
    #     str(tile["speed"]),
    #     str(tile["type"]),
    #     str(tile["w"]),
    #     tile["tag"],
    # ]
    # rows.append("\t".join(row).strip())

    row = [
        # str(tile["index"]),
        "0" if tile["next"] < 0 else str(tile["next"]),
        str(tile["speed"]),
        str(tile["type"]),
        str(tile["w"]),  # weight
        "nullptr" if not tile["tag"] else f'"{tile["tag"]}"',
    ]

    tiledef = "{" + (", ".join(row)) + "},\n"
    tiledata.append(tiledef)

# with open("out/layerdata.tsv", "w") as t:
#    t.write("\n".join(rows))

with open(DEST_PATH + "layerdata.h", "w") as t:
    t.write(COPYRIGHT_NOTICE + HEADER + "\n")

with open(DEST_PATH + "layerdata.cpp", "w") as t:

    fdata = f"{' '*4}".join(tiledata).strip()
    print(fdata)

    lines = [
        COPYRIGHT_NOTICE,
        """
// autogenerated

#include "layerdata.h"

constexpr const layerdata_t g_layerdata[] = {
    {fdata}
};
""".replace(
            "{fdata}", fdata
        ).strip(),
    ]

    t.write("\n".join(lines))
