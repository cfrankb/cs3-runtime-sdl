name: Emscripten C++ WebAssembly Build

on:
  push:
    branches:
      - master
      #- develop
    tags:
      - "v*"
  pull_request:
    branches:
      - master

jobs:
  build-wasm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0 # fetch full history including tags

      - name: Refresh CMakeLists.txt
        run: |
          python3 bin/refresh.py
          cat src/CMakeLists.txt
          cat src/shared/CMakeLists.txt
          cat src/shared/implementers/CMakeLists.txt

      - name: Update build information
        run: |
          bin/setbuild.sh
          cat src/build.h

      - name: Set up Emscripten SDK
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: "latest"
          actions-cache-folder: "emsdk-cache"

      - name: Verify Emscripten Setup
        run: |
          emcc -v
          em++ -v

      - name: download and patch SDL3 source
        run: |
          git submodule update --init --recursive
          ls external/SDL3 -l
          python3 bin/ems/patch-xmp.py

      - name: Build mapzutil
        run: |
          echo "Preparing mapzutil"
          cd itools/mapzutil
          mkdir -p build
          python3 bin/gen.py
          make
          cp build/mapzutil ../../bin

      - name: Strip private maps
        run: |
          echo "Strip private maps"
          bin/mapzutil -s data/levels.mapz

      - name: Build your app
        run: |
          rm data/gamecontrollerdb.txt
          bin/build.sh emsdl3

          echo "Preparing itch.io version"
          mkdir -p build/cs3
          cp data/musics/*.ogg build/cs3
          cp packages/data/win32/cs3-runtime.ico build/cs3/favicon.ico
          cp build/ems/cs3-runtime* build/cs3
          cp LICENSE build/cs3
          mv build/cs3/cs3-runtime.html build/cs3/index.html

          echo "Preparing local version"
          mkdir -p ./build/local
          cp packages/data/win32/cs3-runtime.ico build/local/favicon.ico
          cp ./build/ems/cs3-runtime.* ./build/local
          gzip  ./build/local/*.data ./build/local/*.wasm
          mv ./build/local/cs3-runtime.data.gz ./build/local/cs3-runtime.data
          mv ./build/local/cs3-runtime.wasm.gz ./build/local/cs3-runtime.wasm
          cp build/cs3/*.ogg ./build/local

      - name: Upload WebAssembly Build Artifacts (itchio)
        uses: actions/upload-artifact@v4
        with:
          name: cs3-itchio
          path: |
            build/cs3/*
          retention-days: 7

      - name: Upload WebAssembly Build Artifacts (local)
        uses: actions/upload-artifact@v4
        with:
          name: cs3-local
          path: |
            build/local/*
          retention-days: 7
