#!/usr/bin/python
import glob
import ntpath
import os

TAB = " " * 4


def generate_file(folder, sub_folders):
    if not os.path.isdir(folder):
        print(f"not a directory: {folder}")
        return
    excluded = ["main.cpp"]

    file_path = folder + "/CMakeLists.txt"
    lines = []
    libs = []

    lines.append("# autogenerated")
    lines.append("")

    for sf in sub_folders:
        if not os.path.isdir(sf):
            print(f"not a directory {sf}")
            continue
        path = "/".join(sf.split("/")[1:])
        basename = ntpath.basename(sf)
        lib = f"{basename}_lib"
        libs.append(lib)
        lines.append(f"add_subdirectory(${{CMAKE_CURRENT_SOURCE_DIR}}/{path} {lib})")
    lines.append("")

    basename = ntpath.basename(folder)
    master_lib = f"{basename}_lib"
    lines.append(f"set(SRC_FILES")
    files = glob.glob(f"{folder}/*.cpp")
    files = sorted(files)
    for file in files:
        basename = ntpath.basename(file)
        if basename in excluded:
            continue
        lines.append(f"{TAB}{basename}")

    lines.append(")")
    lines.append("")

    lines.append(f"add_library({master_lib} STATIC ${{SRC_FILES}})")
    lines.append("")

    if libs:
        lines.append(f"target_link_libraries({master_lib}")
        for lib in libs:
            lines.append(f"{TAB}PUBLIC {lib}")
        lines.append(")")

    lines.append("")
    lines.append("# Expose sources to parent for executable")
    lines.append(
        """
set(SRC_EXPORTED_FILES "")
foreach(file ${SRC_FILES})
    list(APPEND SRC_EXPORTED_FILES "${CMAKE_CURRENT_SOURCE_DIR}/${file}")
endforeach()
set(SRC_EXPORTED_FILES ${SRC_EXPORTED_FILES} PARENT_SCOPE)
""".strip()
    )

    prefix = "../" * len(folder.split("/"))
    lines.append("")
    lines.append(
        f"""target_include_directories({master_lib} PUBLIC
    ${{CMAKE_CURRENT_SOURCE_DIR}}
    {prefix}external/SDL3/include
    {prefix}external/SDL3_mixer/include
    {prefix}external/zlib
    )
""".strip()
    )

    lines.append("")
    lines.append("if(IS_MINGW)")
    lines.append(
        f"target_link_libraries({master_lib} PRIVATE SDL3_mixer::SDL3_mixer zlib)"
    )
    lines.append("endif()")
    lines.append("")

    with open(file_path, "w") as tfile:
        tfile.write("\n".join(lines) + "\n")


def generate_tests(folder):
    if not os.path.isdir(folder):
        print(f"not a directory: {folder}")
        return

    file_path = folder + "/CMakeLists.txt"
    lines = []

    lines.append("# autogenerated")
    lines.append("")

    lines.append(f"set(TEST_SOURCES")
    files = glob.glob(f"{folder}/*.cpp")
    files = sorted(files)
    for file in files:
        basename = ntpath.basename(file)
        lines.append(f"{TAB}{basename}")
    lines.append(")")

    lines.append("")
    lines.append("add_executable(cs3-tests ${TEST_SOURCES})")
    lines.append("")
    lines.append(
        "target_link_libraries(cs3-tests PRIVATE src_lib SDL3::SDL3 SDL3_mixer::SDL3_mixer z)"
    )

    lines.append(
        """
target_include_directories(cs3-tests PRIVATE
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/external/SDL3/include
    ${CMAKE_SOURCE_DIR}/external/SDL3_mixer/include
)"""
    )
    lines.append("")
    lines.append("add_test(NAME cs3-runtime-tests COMMAND cs3-tests)")

    lines.append("")
    lines.append('message(STATUS "Building cs3-tests with ${TEST_SOURCES}")')

    with open(file_path, "w") as tfile:
        tfile.write("\n".join(lines) + "\n")


generate_file("src", ["src/shared", "src/shared/implementers"])
generate_file("src/shared", [])
generate_file("src/shared/implementers", [])
generate_tests("tests")
