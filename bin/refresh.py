#!/usr/bin/python
import glob
import ntpath

TAB = " " * 4


def generate_file(folder, sub_folders):

    file_path = folder + "/CMakeLists.txt"
    lines = []
    libs = []

    lines.append("# autogenerated")
    lines.append("")

    for sf in sub_folders:
        path = "/".join(sf.split("/")[1:])
        basename = ntpath.basename(sf)
        lib = f"{basename}_lib"
        libs.append(lib)
        lines.append(f"add_subdirectory(${{CMAKE_CURRENT_SOURCE_DIR}}/{path} {lib})")
    lines.append("")

    basename = ntpath.basename(folder)
    master_lib = f"{basename}_lib"
    lines.append(f"set(SRC_FILES")
    files = glob.glob(f"{folder}/*.cpp")
    files = sorted(files)
    for file in files:
        basename = ntpath.basename(file)
        lines.append(f"{TAB}{basename}")

    lines.append(")")
    lines.append("")

    lines.append(f"add_library({master_lib} STATIC ${{SRC_FILES}})")
    lines.append("")

    if libs:
        lines.append(f"target_link_libraries({master_lib}")
        for lib in libs:
            lines.append(f"{TAB}PUBLIC {lib}")
        lines.append(")")

    lines.append("")
    lines.append("# Expose sources to parent for executable")
    lines.append(
        """
set(SRC_EXPORTED_FILES "")
foreach(file ${SRC_FILES})
    list(APPEND SRC_EXPORTED_FILES "${CMAKE_CURRENT_SOURCE_DIR}/${file}")
endforeach()
set(SRC_EXPORTED_FILES ${SRC_EXPORTED_FILES} PARENT_SCOPE)
""".strip()
    )

    prefix = "../" * len(folder.split("/"))
    lines.append("")
    lines.append(
        f"""target_include_directories({master_lib} PUBLIC
    ${{CMAKE_CURRENT_SOURCE_DIR}}
    {prefix}external/SDL3/include
    {prefix}external/SDL3_mixer/include
    )
""".strip()
    )

    with open(file_path, "w") as tfile:
        tfile.write("\n".join(lines) + "\n")


generate_file("src", ["src/shared", "src/shared/implementers"])
generate_file("src/shared", [])
generate_file("src/shared/implementers", [])
